generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionToken String   @unique
  userId       String   @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String?
  email             String?            @unique
  emailVerified     DateTime?
  image             String?
  password          String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  accounts          Account[]
  auditLogs         AuditLog[]
  seoSnapshots      SeoSnapshot[]
  sessions          Session[]
  userBusinessRoles UserBusinessRole[]
  userRoles         UserRole[]
}

model UserRole {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String @db.Uuid
  roleId String @db.Uuid
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model Business {
  id                String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  slug              String             @unique
  description       String?
  phone             String?
  email             String?
  website           String?
  status            String             @default("active")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deletedAt         DateTime?
  jobs              Job[]
  keywords          Keyword[]
  locations         Location[]
  reviewSyncLogs    ReviewSyncLog[]
  subscriptions     Subscription[]
  userBusinessRoles UserBusinessRole[]
  visibilityMetrics VisibilityMetric[]
  aiVisibilityMetrics AIVisibilityMetric[]
  brandProfiles     BrandProfile[]
  
  // BrandingRise Relations
  competitors   Competitor[]
  visibilitySnapshots VisibilitySnapshot[]
  reports       Report[]
  opportunitiesReports OpportunitiesReport[]
  dna           BrandDNA?
  contentIdeas  ContentIdea[]
  reviews       Review[]
  recommendations BrandRecommendation[]
  brandScores     BrandScore[]
  competitorReviews CompetitorReview[]

  @@index([name])
  @@index([status])
}

model Location {
  id                String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  address           String?
  timezone          String?
  platformIds       Json?
  tags              String[]
  lastSync          DateTime?
  status            String             @default("active")
  businessId        String             @db.Uuid
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deletedAt         DateTime?
  jobs              Job[]
  keywords          Keyword[]
  business          Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  reviewSyncLogs    ReviewSyncLog[]
  visibilityMetrics VisibilityMetric[]
  aiVisibilityMetrics AIVisibilityMetric[]
  reviews           Review[]
  reviewSources     ReviewSource[]
  userBusinessRoles UserBusinessRole[]
  competitorReviews CompetitorReview[]

  @@index([businessId])
}

model Role {
  id                String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String             @unique
  description       String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  permissions       RolePermission[]
  userBusinessRoles UserBusinessRole[]
  userRoles         UserRole[]
}

model Permission {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action      String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       RolePermission[]
}

model RolePermission {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roleId       String     @db.Uuid
  permissionId String     @db.Uuid
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserBusinessRole {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String    @db.Uuid
  businessId String    @db.Uuid
  locationId String?   @db.Uuid
  roleId     String    @db.Uuid
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  business   Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  location   Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  role       Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId, roleId, locationId])
  @@index([userId])
  @@index([businessId])
  @@index([locationId])
}

model Subscription {
  id                   String    @id @default(uuid())
  businessId           String    @db.Uuid
  plan                 String
  status               String
  currentPeriodEnd     DateTime
  stripeSubscriptionId String?   @unique
  stripeCustomerId     String?
  trialEndsAt          DateTime?
  canceledAt           DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime?
  business             Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
  @@index([stripeSubscriptionId])
}

model PasswordResetToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model AuditLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String?  @db.Uuid
  action     String
  entityType String
  entityId   String   @db.Uuid
  details    Json?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityId])
  @@index([createdAt])
}

model ReviewSyncLog {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId    String    @db.Uuid
  locationId    String    @db.Uuid
  platform      String
  status        String
  errorMessage  String?
  errorStack    String?
  reviewsSynced Int       @default(0)
  durationMs    Int?
  requestData   Json?
  responseData  Json?
  jobId         String?   @db.Uuid
  startedAt     DateTime
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  job           Job?      @relation(fields: [jobId], references: [id])
  location      Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([locationId])
  @@index([platform])
  @@index([status])
  @@index([createdAt])
}

model EmailVerificationToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model SeoSnapshot {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  url             String
  healthScore     Int
  categoryScores  Json
  recommendations Json
  seoElements     Json
  userId          String?  @db.Uuid
  createdAt       DateTime @default(now())
  user            User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([url])
}

model Keyword {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId   String        @db.Uuid
  locationId   String?       @db.Uuid
  keyword      String
  searchVolume Int?
  difficulty   Float?
  tags         String[]
  status       String        @default("active")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime?
  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  location     Location?     @relation(fields: [locationId], references: [id])
  ranks        KeywordRank[]

  @@index([businessId])
  @@index([locationId])
  @@index([status])
}

model KeywordRank {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  keywordId          String   @db.Uuid
  rankPosition       Int?
  mapPackPosition    Int?
  hasFeaturedSnippet Boolean  @default(false)
  hasPeopleAlsoAsk   Boolean  @default(false)
  hasLocalPack       Boolean  @default(false)
  hasKnowledgePanel  Boolean  @default(false)
  hasImagePack       Boolean  @default(false)
  hasVideoCarousel   Boolean  @default(false)
  rankingUrl         String?
  searchLocation     String?
  device             String   @default("desktop")
  capturedAt         DateTime @default(now())
  createdAt          DateTime @default(now())
  keyword            Keyword  @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  @@index([keywordId])
  @@index([capturedAt])
}

model VisibilityMetric {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId           String    @db.Uuid
  locationId           String?   @db.Uuid
  periodStart          DateTime
  periodEnd            DateTime
  periodType           String
  mapPackAppearances   Int       @default(0)
  totalTrackedKeywords Int       @default(0)
  mapPackVisibility    Float     @default(0)
  top3Count            Int       @default(0)
  top10Count           Int       @default(0)
  top20Count           Int       @default(0)
  shareOfVoice         Float     @default(0)
  featuredSnippetCount Int       @default(0)
  localPackCount       Int       @default(0)
  computedAt           DateTime  @default(now())
  createdAt            DateTime  @default(now())
  business             Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  location             Location? @relation(fields: [locationId], references: [id])

  @@unique([businessId, locationId, periodStart, periodEnd, periodType])
  @@index([businessId])
  @@index([locationId])
  @@index([periodStart, periodEnd])
}

model Job {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type           String
  status         String
  businessId     String?         @db.Uuid
  locationId     String?         @db.Uuid
  payload        Json?
  result         Json?
  error          Json?
  retryCount     Int             @default(0)
  maxRetries     Int             @default(3)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  startedAt      DateTime?
  completedAt    DateTime?
  failedAt       DateTime?
  business       Business?       @relation(fields: [businessId], references: [id])
  location       Location?       @relation(fields: [locationId], references: [id])
  reviewSyncLogs ReviewSyncLog[]

  @@index([type])
  @@index([status])
  @@index([businessId])
  @@index([locationId])
  @@index([createdAt])
}

model BrandProfile {
  id                   String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId           String                 @db.Uuid
  websiteUrl           String
  title                String?
  description          String?
  status               String                 @default("pending") // 'pending' | 'extracting' | 'completed' | 'failed' | 'pending_confirmation'
  currentExtractedData Json?
  tone                 Json?    // { descriptors: string[], writingRules: { do: string[], dont: string[] }, taglines: string[], messagingPillars: { pillar: string, description: string, ctas: string[] }[] }
  autoReplySettings    Json?    // { enabled: boolean, mode: 'positive' | 'positive_neutral', manualNegativeApproval: boolean, delayHours: number, maxRepliesPerDay: number }
  createdAt            DateTime @default(now())
  updatedAt            DateTime               @updatedAt

  business             Business               @relation(fields: [businessId], references: [id], onDelete: Cascade)
  assets                BrandAsset[]
  colors                BrandColor[]
  fonts                 BrandFont[]
  pages                 BrandPage[]
  socialLinks           BrandSocialLink[]
  extractedDataVersions ExtractedDataVersion[]

  @@index([businessId])
  @@index([status])
}

model ExtractedDataVersion {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandProfileId String       @db.Uuid
  versionNumber  Int
  extractedData  Json
  createdAt      DateTime     @default(now())
  brandProfile   BrandProfile @relation(fields: [brandProfileId], references: [id], onDelete: Cascade)

  @@index([brandProfileId])
}

model BrandAsset {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandProfileId String       @db.Uuid
  type           String       // 'logo', 'favicon', 'og_image', 'header_image'
  url            String
  altText        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  brandProfile   BrandProfile @relation(fields: [brandProfileId], references: [id], onDelete: Cascade)

  @@index([brandProfileId])
}

model BrandColor {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandProfileId String       @db.Uuid
  hexCode        String
  type           String       // 'primary', 'secondary', 'accent', 'background'
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  brandProfile   BrandProfile @relation(fields: [brandProfileId], references: [id], onDelete: Cascade)

  @@index([brandProfileId])
}

model BrandFont {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandProfileId String       @db.Uuid
  family         String
  usage          String       // 'title', 'body', 'ui'
  url            String?      // URL to font file or CSS
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  brandProfile   BrandProfile @relation(fields: [brandProfileId], references: [id], onDelete: Cascade)

  @@index([brandProfileId])
}

model BrandPage {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandProfileId String       @db.Uuid
  type           String       // 'home', 'about', 'services', 'contact'
  url            String
  summary        String?
  content        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  brandProfile   BrandProfile @relation(fields: [brandProfileId], references: [id], onDelete: Cascade)

  @@index([brandProfileId])
}

model BrandSocialLink {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandProfileId String       @db.Uuid
  platform       String       // 'facebook', 'twitter', 'linkedin', 'instagram'
  url            String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  brandProfile   BrandProfile @relation(fields: [brandProfileId], references: [id], onDelete: Cascade)

  @@index([brandProfileId])
}

model FeatureFlag {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String   @unique
  description  String?
  
  // Control logic
  isEnabled    Boolean  @default(false)
  rolloutPercentage Int @default(100)
  rules        Json?    // Flexible targeting rules (e.g. specific users, emails, regions)
  
  // Metadata
  owner        String?
  tags         String[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([name])
}

model SystemSetting {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

// AI Visibility Metrics (Brand mentions, sentiment, etc.)
model AIVisibilityMetric {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId        String    @db.Uuid
  locationId        String?   @db.Uuid

  // Metrics
  visibilityScore   Float     @default(0) // 0-100
  sentimentScore    Float     @default(0) // 0-100
  shareOfVoice      Float     @default(0) // 0-100
  citationAuthority Float     @default(0) // 0-100

  // Time period
  periodStart       DateTime
  periodEnd         DateTime
  periodType        String    // daily, weekly, monthly

  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  business          Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  location          Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  platformData      AIPlatformData[]

  @@index([businessId])
  @@index([locationId])
  @@index([periodStart, periodEnd])
}

// Platform-specific AI data (ChatGPT, Gemini, etc.)
model AIPlatformData {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aIVisibilityMetricId String   @db.Uuid

  // Platform Info
  platform            String    // ChatGPT, Gemini, Claude, Perplexity, etc.
  
  // Metrics
  rank                Int?      // Rank in AI results (null if not found)
  sentiment           String    // Positive, Neutral, Negative
  mentioned           Boolean   @default(false)
  sourcesCount        Int       @default(0)
  
  // Raw response/evidence
  responseSnippet     String?   @db.Text
  
  // Metadata
  capturedAt          DateTime  @default(now())
  
  // Relations
  aIVisibilityMetric  AIVisibilityMetric @relation(fields: [aIVisibilityMetricId], references: [id], onDelete: Cascade)

  @@index([aIVisibilityMetricId])
  @@index([platform])
}

// Competitor Type Enum
enum CompetitorType {
  DIRECT_LOCAL  // Direct local competitor
  CONTENT       // Content competitor (blogs, guides)
  AGGREGATOR    // Directories, aggregators (Yelp, etc.)
  UNKNOWN       // Not yet classified
}

// BrandingRise: Competitor Analysis
model Competitor {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId      String         @db.Uuid
  name            String
  website         String?
  
  // Discovery & Classification
  domain          String?                    // Normalized domain (e.g., example.com)
  type            CompetitorType @default(UNKNOWN)
  source          String?                    // "discovery" or "manual"
  relevanceScore  Float?                     // 0-100 ranking from SERP
  ranking         Int?                       // Position in competitor list
  isUserAdded     Boolean        @default(false)
  isHidden        Boolean        @default(false)
  
  // Metadata
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  business        Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  snapshots       CompetitorSnapshot[]

  @@unique([businessId, name])
  @@unique([businessId, domain])
  @@index([businessId])
  @@index([type])
}

model CompetitorSnapshot {
  id                String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  competitorId      String     @db.Uuid
  
  // Extracted Brand Elements
  headline          String?    @db.Text      // Main UVP/headline
  uvp               String?    @db.Text      // Full value proposition
  serviceList       String[]                 // List of services offered
  pricingCues       String[]                 // Pricing indicators found
  trustSignals      Json?                    // { badges: [], certifications: [], reviewCount: 0, avgRating: 0 }
  ctaStyles         String[]                 // CTA button texts/styles
  contentCategories String[]                 // Blog/content categories
  
  // Differentiators Analysis (AI-generated)
  differentiators   Json?                    // { strengths: [], weaknesses: [], unique: [] }
  whatToLearn       String[]                 // Insights to adopt
  whatToAvoid       String[]                 // Patterns to avoid
  
  // Optional Enrichments
  techStack         Json?                    // Wappalyzer data
  trafficMetrics    Json?                    // SimilarWeb data
  
  // Legacy field for backwards compatibility
  metrics           Json?
  
  capturedAt        DateTime   @default(now())
  
  competitor        Competitor @relation(fields: [competitorId], references: [id], onDelete: Cascade)
  
  @@index([competitorId])
  @@index([capturedAt])
}

// BrandingRise: Visibility Snapshots (for unified dashboard history)
model VisibilitySnapshot {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId  String    @db.Uuid
  
  range       String    // 7d, 30d, 90d (snapshot covers this range ending at capturedAt)
  score       Float     // Overall visibility score (0-100)
  
  // Detailed breakdown
  breakdown   Json      // { "organic": 40, "maps": 30, "social": 15, "reviews": 15 }
  
  capturedAt  DateTime  @default(now())
  
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([capturedAt])
}

// BrandingRise: Reports
model Report {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId  String    @db.Uuid
  
  title       String
  version     String    // v1.0, v1.1 etc.
  
  // Content
  htmlContent String    @db.Text
  pdfUrl      String?   // Optional link if we generate PDF later
  
  // Metadata
  generatedBy String?   @db.Uuid // specific user who generated it
  generatedAt DateTime  @default(now())
  
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([generatedAt])
}

// BrandingRise: Opportunities Report
model OpportunitiesReport {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId         String    @db.Uuid
  
  // Report Content
  positioningMap     Json                    // { competitors: [...], axes: { x: 'price', y: 'quality' } }
  gaps               Json                    // [{ title: '', description: '', priority: 1-10 }]
  strategies         Json                    // [{ title: '', description: '', pros: [], cons: [] }]
  suggestedTaglines  String[]
  contentIdeas       Json                    // [{ topic: '', rationale: '', competitorGap: '' }]
  
  // Metadata
  generatedAt        DateTime  @default(now())
  expiresAt          DateTime?
  shareToken         String?   @unique       // For shareable link
  pdfUrl             String?
  
  business           Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([shareToken])
}

model BrandDNA {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId  String   @unique @db.Uuid
  values      String[]
  voice       String?
  audience    String?
  mission     String?
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model ContentIdea {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId  String   @db.Uuid
  title       String
  description String?
  platform    String
  status      String   @default("draft")
  createdAt   DateTime @default(now())
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
}

model Review {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId  String   @db.Uuid
  locationId  String?  @db.Uuid
  platform    String
  externalId  String
  author      String
  rating      Int
  content     String?  @db.Text
  sentiment   String?  // Positive, Neutral, Negative
  tags        String[] @default([])
  aiSuggestions Json?  // { suggestedReply?: string, analysis?: string }
  publishedAt DateTime
  
  response    String?  @db.Text
  respondedAt DateTime?
  
  replyStatus String?  // 'pending_approval', 'approved', 'posted', 'rejected'
  replyError  String?  // Log reason if skipped/failed
  
  createdAt   DateTime @default(now())
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  location    Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  
  reviewSourceId String?       @db.Uuid
  reviewSource   ReviewSource? @relation(fields: [reviewSourceId], references: [id])

  @@unique([platform, externalId])
  @@index([businessId])
}

model ReviewSource {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId    String   @db.Uuid
  platform      String   // 'google', 'facebook', 'yelp'
  accessToken   String?  @db.Text
  refreshToken  String?  @db.Text
  expiresAt     BigInt?  // timestamp in ms
  status        String   @default("active") // active, disconnected, expired
  metadata      Json?    // platform specific IDs (accountId, locationName)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  location      Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  reviews       Review[]

  @@unique([locationId, platform])
  @@index([locationId])
}

// BrandingRise: AI-Generated Recommendations
model BrandRecommendation {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId  String   @db.Uuid
  
  // Categorization
  category    String   // 'search', 'local', 'social', 'reputation', 'conversion', 'content'
  
  // Recommendation Details
  title       String
  description String   @db.Text
  why         String[] // Array of reasons/rationale
  steps       String[] // Array of actionable steps
  
  // Prioritization
  impact      String   // 'low', 'medium', 'high', 'critical'
  effort      String   // 'low', 'medium', 'high'
  confidence  Float    @default(0) // 0-100, AI confidence in this recommendation
  priorityScore Float  @default(0) // Computed: (impact * confidence) / effort
  
  // KPI Tracking
  kpiTarget   Json?    // { metric: 'visibility_score', target: 75, timeframe: '30d' }
  
  // Status & Lifecycle
  status      String   @default("open") // 'open', 'in_progress', 'done', 'dismissed'
  notes       String?  @db.Text // User notes
  
  // Metadata
  generatedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  dismissedAt DateTime?
  completedAt DateTime?
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([category])
  @@index([status])
  @@index([priorityScore])
  @@index([generatedAt])
}

// BrandingRise: Computed Brand Scores
model BrandScore {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId            String   @db.Uuid
  
  // Core Scores (0-100)
  visibilityScore       Float    @default(0)
  trustScore            Float    @default(0)
  consistencyScore      Float    @default(0)
  
  // Visibility Breakdown (weighted components)
  visibilityBreakdown   Json     // { search: 20, local: 30, social: 15, reputation: 20, consistency: 15 }
  
  // Trust Breakdown
  trustBreakdown        Json     // { rating: 4.5, reviewCount: 120, responseRate: 0.85, sentiment: 0.75 }
  
  // Consistency Breakdown
  consistencyBreakdown  Json     // { namingConsistency: 0.9, brandingConsistency: 0.8, messagingConsistency: 0.7 }
  
  // Metadata
  computedAt            DateTime @default(now())
  periodStart           DateTime
  periodEnd             DateTime
  
  business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([businessId, periodStart, periodEnd])
  @@index([businessId])
  @@index([computedAt])
}

// Review Analytics: Competitor Review Data
model CompetitorReview {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId      String    @db.Uuid
  locationId      String?   @db.Uuid
  
  // Competitor Info
  competitorName  String
  
  // Review Metrics
  averageRating   Float
  totalReviews    Int
  
  // Source of data
  source          String    // 'google', 'manual', 'api'
  
  // Metadata
  capturedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())
  
  // Relations
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  location        Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  
  @@index([businessId])
  @@index([locationId])
  @@index([capturedAt])
}

